name: Deploy Mandanga Platform

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Desplegar en VPS vía SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }} 
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "--- INICIANDO DEPLOY ATÓMICO ---"
            
            # 1. Definir rutas
            PROJECT_DIR="/var/www/mandanga-platform"
            TEMP_DIR="/var/www/mandanga_temp_$(date +%s)"
            
            # 2. Clonar el repositorio limpio en una carpeta temporal
            echo "Clonando versión limpia de GitHub..."
            git clone -b main https://github.com/tu-usuario/tu-repo.git $TEMP_DIR
            
            # 3. Borrar directorios críticos en el proyecto actual
            echo "Limpiando directorios antiguos..."
            # Borramos las carpetas que contienen la lógica para asegurar frescura
            rm -rf $PROJECT_DIR/app/Http
            rm -rf $PROJECT_DIR/app/Models
            rm -rf $PROJECT_DIR/app/Services
            rm -rf $PROJECT_DIR/routes
            rm -rf $PROJECT_DIR/database
            rm -rf $PROJECT_DIR/config
            
            # 4. Copiar los archivos nuevos desde la temporal al proyecto real
            echo "Trasladando archivos nuevos..."
            cp -R $TEMP_DIR/app/Http $PROJECT_DIR/app/
            cp -R $TEMP_DIR/app/Models $PROJECT_DIR/app/
            cp -R $TEMP_DIR/app/Services $PROJECT_DIR/app/
            cp -R $TEMP_DIR/routes $PROJECT_DIR/
            cp -R $TEMP_DIR/database $PROJECT_DIR/
            cp -R $TEMP_DIR/config $PROJECT_DIR/
            
            # Copiar también el composer.json por si hubo cambios en dependencias
            cp $TEMP_DIR/composer.json $PROJECT_DIR/
            
            # 5. Limpiar y ajustar
            echo "Finalizando y limpiando..."
            rm -rf $TEMP_DIR
            
            cd $PROJECT_DIR
            
            # Reinstalar dependencias y limpiar TODO en Laravel
            composer install --no-interaction --prefer-dist --optimize-autoloader
            php artisan optimize:clear
            
            # Asegurar permisos una última vez
            sudo chown -R mandanga3:mandanga3 $PROJECT_DIR
            
            echo "--- DEPLOY ATÓMICO FINALIZADO ---"