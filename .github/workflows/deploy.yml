name: Deploy Mandanga Platform

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Desplegar en VPS vía SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }} 
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |          
            cd /var/www/mandanga-platform
            
            # A. Forzar a Git a ignorar cambios locales de permisos
            git config core.fileMode false
            
            # B. Limpieza atómica: Descartar cualquier basura antes de traer lo nuevo
            git reset --hard HEAD
            git clean -fd
            
            # C. Sincronizar
            git fetch origin main
            git reset --hard origin/main
            
            # D. Optimizar Laravel
            php artisan optimize:clear
            echo "--- DATOS DE CONEXIÓN ---"
            echo "IP Pública (IPv4): $(curl -4 -s https://ifconfig.me)"
            echo "IP Pública (IPv6): $(curl -6 -s https://ifconfig.me || echo 'No disponible')"
            echo "Usuario: $(whoami)"
            echo "Directorio inicial: $(pwd)"
            echo "--------------------------"            
                        
            # 1. Configuración de seguridad
            git config --global --add safe.directory /var/www/mandanga-platform
            
            # 2. Diagnóstico del archivo ANTES del reset
            echo "--- ANTES DEL RESET ---"
            ls -la routes/api.php
            echo "Último commit local: $(git log -1 --format='%s')"
            
            # 3. FORZAR ACTUALIZACIÓN (Descartar todo lo local)
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            
            # 4. Diagnóstico DESPUÉS del reset
            echo "--- DESPUÉS DEL RESET ---"
            ls -la routes/api.php
            echo "Nuevo commit local: $(git log -1 --format='%s')"
            
            # 5. Limpieza de Laravel (Crucial para ver cambios en la API)
            composer install --no-interaction --prefer-dist --optimize-autoloader
            php artisan optimize:clear
            php artisan route:clear
            
            echo "--- PRUEBA DE CONTENIDO ---"
            # Buscamos si existe alguna ruta de test que hayas puesto en api.php
            grep "test" routes/api.php || echo "No se encontró la palabra 'test' en api.php"
            
            echo "¡Deploy finalizado!"