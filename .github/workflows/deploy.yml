name: Deploy Mandanga Platform

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Desplegar en VPS vía SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }} 
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            PROJECT_DIR="/var/www/mandanga-platform"
            cd $PROJECT_DIR

            echo "--- LIMPIANDO ESTADO DE GIT ---"
            # Forzamos a git a que olvide cualquier cambio local o de permisos
            git config core.fileMode false
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "--- FORZANDO ACTUALIZACIÓN DE ARCHIVOS CRÍTICOS ---"
            # Esto obliga a git a sobreescribir estos archivos específicos 
            # desde el índice, por si acaso hubo errores de permisos.
            git checkout origin/main -- app/Http/
            git checkout origin/main -- app/Models/
            git checkout origin/main -- routes/
            git checkout origin/main -- config/

            echo "--- LIMPIANDO LARAVEL ---"
            composer install --no-interaction --prefer-dist --optimize-autoloader
            
            # Usamos -f para que no falle si no hay cachés previas
            php artisan optimize:clear || echo "Caché ya estaba limpia"
            
            echo "--- VERIFICACIÓN ---"
            if [ -f "routes/api.php" ]; then
                echo "✅ routes/api.php existe."
                grep "TEST DIRECTO" routes/api.php || echo "⚠️ El texto de test no está en el archivo."
            else
                echo "❌ ERROR: routes/api.php sigue sin aparecer."
                exit 1
            fi